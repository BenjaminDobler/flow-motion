@let mpp = timelineService.millisecondsPerPixel();

<div class="timeline-container">
  <div class="labels">
    <div style="position: absolute; left: 0; top: 0; width: 250px; z-index: 2">
      <div class="header">
        <timeline-controls></timeline-controls>
      </div>

      @for (group of timelineService.timeline().groups; track $index) {
        <div class="label group">
          {{ group.name }}
        </div>

        @for (track of group.tracks; track $index) {
            <div class="label">
              {{ track.name }}
            </div>
          
        }
      }
    </div>
  </div>

  <div class="tracks" [style.minWidth]="timelineService.duration() / mpp + 'px'">
    <div class="header track-container">
      <div class="track-spacer header"></div>
      <timeline-ruler style="flex: 1" [duration]="20000" [millisecondsPerPixel]="mpp"></timeline-ruler>
    </div>

    <div style="position: relative">
      @for (group of timelineService.timeline().groups; track $index) {
        <div class="track-container">
          <div class="track-spacer group"></div>
          <div class="track group" style="flex: 1"></div>
        </div>
        @for (track of group.tracks; track $index) {
          <div class="track-container">
            <div class="track-spacer"></div>

            <div class="track" style="flex: 1" [contextMenu]="trackContextMenu" (contextMenuSelected)="onTrackContextMenuSelected($event, track, group)">
              @for (tween of track.tweens; track $index) {
                <timeline-tween
                  (click)="onTweenClick($event, tween, track, group)"
                  [minY]="0"
                  [maxY]="0"
                  [minX]="0"
                  [class.selected]="selectedTween() === tween"
                  [showCursor]="false"
                  [x]="tween.start.time / mpp"
                  positioning="transform"
                  [resizable]="false"
                  [tween]="tween"
                  [timeline]="timelineService.timeline()"
                  (dragEnd)="onTweenDragEnd()"
                  (dragStart)="onTweenDragStart()"
                  (positionUpdated)="onTweenPositionUpdated($event, tween, track, group)"
                ></timeline-tween>
              }
              @for (keyframe of track.keyframes; track $index) {
                <timeline-keyframe
                  [minY]="5"
                  [maxY]="5"
                  [minX]="0"
                  [showCursor]="false"
                  [x]="keyframe.time / mpp"
                  [y]="5"
                  [bondcontainer]="`keyframe`"
                  [positioning]="'transform'"
                  [resizable]="false"
                  (tween)="onTween($event, group, track)"
                  (delete)="onDeleteKeyframe($event, group, track)"
                  [keyframe]="keyframe"
                  (positionUpdated)="onKeyframePositionUpdated($event, keyframe, track, group)"
                  [timeline]="timelineService.timeline()"
                  (click)="onKeyframeClick($event, keyframe, track, group)"
                  (dragEnd)="onKeyframeDragEnd($event, keyframe, track, group)"
                ></timeline-keyframe>
              }
            </div>
          </div>
        
        }
      }
      <div [style.transform]="`translateX(${timelineService.position() / mpp + 10}px)`" class="pos-line"></div>
    </div>
  </div>
</div>
