<svg style="position: absolute; left: 0; top: 0; pointer-events: none" width="100%" height="100%">
  <defs>
    <!-- A marker to be used as an arrowhead -->
    <!-- <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" fill="context-stroke" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>

    <marker id="arrow2" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" />
    </marker>

    <marker id="circle" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <circle cx="5" cy="5" r="5" />
    </marker>

    <marker id="square" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <rect x="2" y="2" width="6" height="6" />
    </marker> -->

    @for (link of dragService.links(); track $index) {
      <marker [attr.id]="'start-arrow-' + $index" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" fill="context-stroke" [attr.orient]="link.properties.startMarkerOrient()">
        <path d="M 0 0 L 10 5 L 0 10 z" />
      </marker>

      <marker [attr.id]="'start-arrow2-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" [attr.orient]="link.properties.startMarkerOrient()">
        <path d="M 0 0 L 10 5 L 0 10 z" />
      </marker>

      <marker [attr.id]="'start-circle-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <circle cx="5" cy="5" r="5" />
      </marker>

      <marker [attr.id]="'start-square-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <rect x="2" y="2" width="6" height="6" />
      </marker>

      <marker [attr.id]="'end-arrow-' + $index" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" fill="context-stroke" [attr.orient]="link.properties.endMarkerOrient()">
        <path d="M 0 0 L 10 5 L 0 10 z" />
      </marker>

      <marker [attr.id]="'end-arrow2-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" [attr.orient]="link.properties.endMarkerOrient()">
        <path d="M 0 0 L 10 5 L 0 10 z" />
      </marker>

      <marker [attr.id]="'end-circle-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <circle cx="5" cy="5" r="5" />
      </marker>

      <marker [attr.id]="'end-square-' + $index" stroke="context-stroke" fill="context-stroke" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
        <rect x="2" y="2" width="6" height="6" />
      </marker>
    }

    <filter x="0" y="0" width="1" height="1" id="solid">
      <feFlood flood-color="black" result="bg" />
      <feMerge>
        <feMergeNode in="bg" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>
  @for (link of dragService.links(); track $index) {
    <path
      id="link-{{ $index }}"
      style="pointer-events: all"
      connection
      class="draw"
      [attr.stroke]="link.properties.stroke()"
      [attr.stroke-width]="link.properties.strokeWidth()"
      [attr.d]="link.path()"
      [attr.stroke-dasharray]="link.properties.strokeDasharray()"
      fill="none"
      [link]="link"
      [attr.marker-end]="`url(#end-${link.properties.endMarker()}-${$index})`"
      [attr.marker-start]="`url(#start-${link.properties.startMarker()}-${$index})`"
    />

    />

    @if (link.properties.textOnPath() !== '') {
      <text font-size="20">
        <textPath [attr.startOffset]="link.properties.totalLength() / 2" text-anchor="middle" dominant-baseline="middle" [attr.href]="'#link-' + $index">{{ link.properties.textOnPath() }}</textPath>
      </text>
    }

    @let animate = link.properties.animate();
    @if (animate && pathanimation()) {
      <ng-container *ngTemplateOutlet="pathanimation(); context: { path: link.path() }"></ng-container>
    } @else if (animate) {
      @let duration = link.properties.animationBubbleDuration();
      @let count = link.properties.animationBubbleCount();
      @let step = duration / count;

      @for (count of countToArray(link.properties.animationBubbleCount()); track $index) {
        <circle [attr.r]="link.properties.animationBubbleRadius()" [attr.fill]="link.properties.animationBubbleColor()">
          <animateMotion [attr.dur]="duration + 's'" [attr.begin]="$index * step + 's'" repeatCount="indefinite" [attr.path]="link.path()" />
        </circle>

        <!-- <g>
          <svg
            height="24px"
            width="24px"
            style="transform: translate(-12px, -12px);"
            version="1.1"
            id="Layer_1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 0 473.931 473.931"
            xml:space="preserve"
            fill="#000000"
          >
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
              <circle style="fill: #ffc10e" cx="236.966" cy="236.966" r="236.966"></circle>
              <g>
                <path
                  style="fill: #333333"
                  d="M383.164,237.123c-1.332,80.699-65.514,144.873-146.213,146.206 c-80.702,1.332-144.907-67.52-146.206-146.206c-0.198-12.052-18.907-12.071-18.709,0c1.5,90.921,73.993,163.414,164.914,164.914 c90.929,1.5,163.455-76.25,164.922-164.914C402.071,225.052,383.362,225.071,383.164,237.123L383.164,237.123z"
                ></path>
                <circle style="fill: #333333" cx="164.937" cy="155.227" r="37.216"></circle>
                <circle style="fill: #333333" cx="305.664" cy="155.227" r="37.216"></circle>
              </g>
            </g>
          </svg>
          <animateMotion [attr.dur]="duration + 's'" [attr.begin]="$index * step + 's'" repeatCount="indefinite" [attr.path]="link.path()" />
        </g> -->
      }
    }
  }

  @if (dragService.snapLink()) {
    <path
      class="draw"
      [attr.stroke]="dragService.snapLink()?.properties?.stroke()"
      [attr.stroke-width]="dragService.snapLink()?.properties?.strokeWidth()"
      [attr.d]="dragService.snapLink()?.path()"
      [attr.stroke-dasharray]="dragService.snapLink()?.properties?.strokeDasharray()"
      fill="none"
    />
  }
</svg>

@for (link of dragService.links(); track $index) {
  @if (link.properties.textOnPath() !== '') {
    <div [style.transform]="`translate(${link.properties.midPoint().x}px, ${link.properties.midPoint().y}px)`" style="position: absolute; left: 0; top: 0; pointer-events: none">
      <div style="transform: translateX(-50%)">
        {{ link.properties.textOnPath() }}
      </div>
    </div>
  }
}
